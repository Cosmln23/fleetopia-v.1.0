{
    "$schema": "http://json-schema.org/draft-07/schema#",
    "$id": "https://example.com/db-log.schema.json",
    "type": "object",
    "required": [
      "schema_version",
      "date",
      "author",
      "change_type",
      "migration_id",
      "tables",
      "columns",
      "rationale",
      "risk",
      "links",
      "evidence",
      "validation",
      "multitenant",
      "security",
      "data_quality",
      "modeling",
      "performance",
      "ops"
    ],
    "properties": {
      "schema_version": { "type": "integer", "minimum": 1 },
      "date": { "type": "string", "pattern": "^\\d{4}-\\d{2}-\\d{2}$" },
      "author": { "type": "string" },
      "change_type": {
        "type": "string",
        "enum": [
          "bootstrap",
          "table_add",
          "table_alter",
          "column_add",
          "column_alter",
          "column_drop",
          "index_add",
          "index_drop",
          "rls_update",
          "role_update",
          "cache_key",
          "replica_cfg",
          "other"
        ]
      },
      "migration_id": { "type": "string" },
      "tables": { "type": "array", "items": { "type": "string" } },
      "columns": { "type": "array", "items": { "type": "string" } },
      "index_name": { "type": ["string", "null"] },
      "policy_name": { "type": ["string", "null"] },
      "role": { "type": ["string", "null"] },
      "rationale": { "type": "string", "minLength": 5 },
      "risk": { "type": "string", "enum": ["low", "medium", "high"] },
      "links": {
        "type": "object",
        "required": ["pr_url", "migration_path"],
        "properties": {
          "pr_url": { "type": "string" },
          "migration_path": { "type": "string" }
        }
      },
      "evidence": {
        "type": "object",
        "required": ["before_ms", "after_ms", "explain_before", "explain_after"],
        "properties": {
          "before_ms": { "type": ["number", "null"] },
          "after_ms": { "type": ["number", "null"] },
          "explain_before": { "type": "string" },
          "explain_after": { "type": "string" }
        }
      },
      "validation": {
        "type": "object",
        "required": ["did_run_checks", "notes"],
        "properties": {
          "did_run_checks": { "type": "boolean" },
          "notes": { "type": "string" }
        }
      },
      "multitenant": {
        "type": "object",
        "required": ["enabled", "tenant_key"],
        "properties": {
          "enabled": { "type": "boolean" },
          "tenant_key": { "type": "string" }
        }
      },
      "security": {
        "type": "object",
        "required": ["rls", "roles"],
        "properties": {
          "rls": {
            "type": "object",
            "required": ["status", "notes"],
            "properties": {
              "status": { "type": "string", "enum": ["off", "on", "mixed"] },
              "notes": { "type": "string" }
            }
          },
          "roles": {
            "type": "array",
            "items": {
              "type": "object",
              "required": ["name", "scope"],
              "properties": {
                "name": { "type": "string" },
                "scope": { "type": "string" }
              }
            }
          }
        }
      },
      "data_quality": {
        "type": "object",
        "required": ["pii", "retention"],
        "properties": {
          "pii": {
            "type": "array",
            "items": {
              "type": "object",
              "required": ["table", "columns"],
              "properties": {
                "table": { "type": "string" },
                "columns": { "type": "array", "items": { "type": "string" } }
              }
            }
          },
          "retention": {
            "type": "array",
            "items": {
              "type": "object",
              "required": ["table", "policy"],
              "properties": {
                "table": { "type": "string" },
                "policy": { "type": "string" }
              }
            }
          }
        }
      },
      "modeling": {
        "type": "object",
        "required": ["fks", "cascade"],
        "properties": {
          "fks": { "type": "array", "items": { "type": "string" } },
          "cascade": {
            "type": "array",
            "items": {
              "type": "object",
              "required": ["path", "mode"],
              "properties": {
                "path": { "type": "string" },
                "mode": { "type": "string" }
              }
            }
          }
        }
      },
      "performance": {
        "type": "object",
        "required": ["critical_indexes", "slow_query_threshold_ms"],
        "properties": {
          "critical_indexes": {
            "type": "array",
            "items": {
              "type": "object",
              "required": ["table", "columns", "rationale"],
              "properties": {
                "table": { "type": "string" },
                "columns": { "type": "array", "items": { "type": "string" } },
                "rationale": { "type": "string" }
              }
            }
          },
          "slow_query_threshold_ms": { "type": "number" }
        }
      },
      "ops": {
        "type": "object",
        "required": ["backups", "replicas"],
        "properties": {
          "backups": {
            "type": "object",
            "required": ["pit_recovery", "retention_days"],
            "properties": {
              "pit_recovery": { "type": "boolean" },
              "retention_days": { "type": "number" }
            }
          },
          "replicas": {
            "type": "object",
            "required": ["read_replica"],
            "properties": { "read_replica": { "type": "string" } }
          }
        }
      }
    },
    "allOf": [
      {
        "if": { "properties": { "change_type": { "const": "index_add" } } },
        "then": { "required": ["index_name"], "properties": { "index_name": { "type": "string" } } }
      },
      {
        "if": { "properties": { "change_type": { "const": "rls_update" } } },
        "then": { "required": ["policy_name"], "properties": { "policy_name": { "type": "string" } } }
      }
    ]
  }